name: Auto update PR branch

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-branch:
    if: github.event.pull_request.state == 'open' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Try native GitHub update branch API
        id: update
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            try {
              const res = await github.rest.pulls.updateBranch({
                owner,
                repo,
                pull_number,
                expected_head_sha: context.payload.pull_request.head.sha,
              });

              core.info(`updateBranch status: ${res.status}`);
              core.setOutput('updated', 'true');
            } catch (error) {
              core.warning(`updateBranch failed: ${error.message}`);
              core.setOutput('updated', 'false');
            }

      - name: Checkout PR head branch (same-repo only)
        if: steps.update.outputs.updated == 'false' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Auto-resolve conflicts by preferring PR branch changes
        if: steps.update.outputs.updated == 'false' && github.event.pull_request.head.repo.full_name == github.repository
        env:
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin "$BASE_REF"

          # 首选：常规 merge，并在文本冲突时优先保留 PR 分支（当前分支）内容
          if git merge --no-edit -X ours "origin/$BASE_REF"; then
            echo "Merged cleanly (or auto-resolved by strategy)."
          else
            echo "Merge still conflicted; force-resolving by keeping PR branch versions."
            git checkout --ours .
            git add -A
            git commit -m "chore: auto-resolve merge conflicts by preferring PR branch"
          fi

          git push origin "HEAD:$HEAD_REF"

      - name: Comment when auto-resolution is skipped (fork PR)
        if: steps.update.outputs.updated == 'false' && github.event.pull_request.head.repo.full_name != github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.pull_request.number;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                '⚠️ 已尝试自动更新分支，但该 PR 来自 fork，工作流不会直接向对方分支 push。',
                '',
                '请在 PR 分支手动同步基线，或由维护者在本仓库分支上复现并继续。'
              ].join('\\n')
            });
